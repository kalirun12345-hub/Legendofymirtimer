<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ymir Boss Tracker Pro</title>
    <style>
        :root { --gold: #d4af37; --dark-bg: #0f1215; --card-bg: #1c2126; --border: #343b42; --red: #e74c3c; --green: #2ecc71; --text-gray: #888; }
        body { background-color: var(--dark-bg); color: white; font-family: sans-serif; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        h1 { color: var(--gold); text-transform: uppercase; letter-spacing: 3px; margin-bottom: 20px; }
        
        .sync-indicator { font-size: 0.7rem; color: var(--text-gray); margin-bottom: 15px; text-transform: uppercase; }
        .sync-indicator.syncing { color: var(--gold); }

        .tabs { display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; justify-content: center; }
        .tab-btn { background: var(--card-bg); border: 1px solid var(--border); color: var(--text-gray); padding: 12px 24px; cursor: pointer; border-radius: 6px; font-weight: bold; }
        .tab-btn.active { border-color: var(--gold); color: var(--gold); background: rgba(212, 175, 55, 0.1); }
        
        .floor-content { display: none; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 20px; width: 100%; max-width: 1200px; }
        .floor-content.active { display: grid; }
        
        .boss-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 20px; text-align: center; }
        .boss-name { font-size: 1.4rem; font-weight: bold; margin-bottom: 5px; }
        .timer { font-size: 2.2rem; font-family: monospace; margin: 15px 0; color: var(--green); }
        .timer.counting { color: var(--gold); font-weight: bold; }
        
        .killed-btn { background: transparent; border: 1px solid var(--red); color: var(--red); padding: 10px 20px; border-radius: 6px; cursor: pointer; width: 100%; font-weight: bold; }
        .killed-btn:hover { background: var(--red); color: white; }
    </style>
</head>
<body>

    <h1>ðŸ”± Legend of Ymir ðŸ”±</h1>
    <div id="sync-status" class="sync-indicator">Live Sync Enabled</div>

    <div class="tabs">
        <button class="tab-btn active" onclick="showFloor('floor1')">Floor 1</button>
        <button class="tab-btn" onclick="showFloor('floor2')">Floor 2</button>
        <button class="tab-btn" onclick="showFloor('floor3')">Floor 3</button>
        <button class="tab-btn" onclick="showFloor('floor4')">Floor 4</button>
    </div>

    <div id="floors-container" style="width: 100%;"></div>

    <script>
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzM2yeTWYle0Ufevgdw9Q98hkhE4Crcjo6iRTAdDh_rNCpYG9XqvMPbPFj7j9WekxqA/exec"; 
        const bosses = ["Volva", "Berserker", "Warlord", "Skald"];
        const floors = ["floor1", "floor2", "floor3", "floor4"];

        // UI Generation
        const container = document.getElementById('floors-container');
        floors.forEach((floor, fIdx) => {
            let floorDiv = document.createElement('div');
            floorDiv.id = floor;
            floorDiv.className = `floor-content ${fIdx === 0 ? 'active' : ''}`;
            bosses.forEach(boss => {
                const bossId = `${floor}-${boss}`;
                floorDiv.innerHTML += `
                    <div class="boss-card">
                        <div class="boss-name">${boss}</div>
                        <div class="timer" id="time-${bossId}">ALIVE</div>
                        <button class="killed-btn" onclick="markKilled('${bossId}', '${boss}', '${floor}')">MARK KILLED</button>
                    </div>`;
            });
            container.appendChild(floorDiv);
        });

        function showFloor(floorId) {
            document.querySelectorAll('.floor-content').forEach(f => f.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(floorId).classList.add('active');
            if(window.event) window.event.currentTarget.classList.add('active');
        }

        // AUTO-SYNC LOGIC
        async function fetchTimersFromGoogle() {
            const statusEl = document.getElementById('sync-status');
            statusEl.innerText = "Syncing with Spreadsheet...";
            statusEl.classList.add('syncing');

            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ type: "GET_TIMERS" })
                });
                const allRows = await response.json();
                
                // Process only the last 50 entries to stay fast
                const relevantData = allRows.slice(1).slice(-50); 
                const now = new Date().getTime();
                const respawnMins = parseInt(localStorage.getItem('respawn_setting')) || 120;

                relevantData.forEach(row => {
                    const bName = row[0];
                    const fName = row[1];
                    const kTimeIso = row[2];
                    const id = `${fName}-${bName}`;

                    const killTime = new Date(kTimeIso).getTime();
                    const targetTime = killTime + (respawnMins * 60 * 1000);

                    // If the boss is still dead, update local storage
                    if (targetTime > now) {
                        localStorage.setItem(id, targetTime.toString());
                    }
                });

                updateDisplay();
                statusEl.innerText = "Live Sync Enabled (Updated Just Now)";
            } catch (err) {
                console.error("Sync Error:", err);
                statusEl.innerText = "Sync Offline (Retrying...)";
            }
            statusEl.classList.remove('syncing');
        }

        function markKilled(id, bossName, floorName) {
            const now = new Date();
            const mins = parseInt(localStorage.getItem('respawn_setting')) || 120;
            const targetTime = now.getTime() + (mins * 60 * 1000);
            
            localStorage.setItem(id, targetTime.toString());
            updateDisplay();

            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ boss: bossName, floor: floorName, time: now.toISOString() })
            });
        }

        function updateDisplay() {
            const currentTime = new Date().getTime();
            floors.forEach(f => {
                bosses.forEach(b => {
                    const id = `${f}-${b}`;
                    const display = document.getElementById(`time-${id}`);
                    const savedValue = localStorage.getItem(id);
                    
                    if (savedValue) {
                        const target = parseInt(savedValue);
                        const diff = target - currentTime;

                        if (diff > 0) {
                            const h = Math.floor(diff / 3600000);
                            const m = Math.floor((diff % 3600000) / 60000);
                            const s = Math.floor((diff % 60000) / 1000);
                            display.innerHTML = h + "h " + m.toString().padStart(2, '0') + "m " + s.toString().padStart(2, '0') + "s";
                            display.classList.add('counting');
                        } else {
                            display.innerHTML = "ALIVE";
                            display.classList.remove('counting');
                        }
                    }
                });
            });
        }

        // Run UI update every second
        setInterval(updateDisplay, 1000);

        // Run AUTO-SYNC every 30 seconds
        setInterval(fetchTimersFromGoogle, 30000);

        // Run once on initial load
        window.onload = () => {
            updateDisplay();
            fetchTimersFromGoogle();
        };
    </script>
</body>
</html>
